#ifndef COILBASE
#include "basic/EM_defines.h"
#endif
#include "fem/EM_Integrator.h"


//const double * EM_Gauss2dAdaptive1dIntegrator::P=EM_AdaptiveIntegrator::P;

const double EM_AdaptiveIntegrator::P[381] =  {
     0.77459666924148337704e+00,0.55555555555555555556e+00,
     0.88888888888888888889e+00,0.26848808986833344073e+00,
     0.96049126870802028342e+00,0.10465622602646726519e+00,
     0.43424374934680255800e+00,0.40139741477596222291e+00,
     0.45091653865847414235e+00,0.13441525524378422036e+00,
     0.51603282997079739697e-01,0.20062852937698902103e+00,
     0.99383196321275502221e+00,0.17001719629940260339e-01,
     0.88845923287225699889e+00,0.92927195315124537686e-01,
     0.62110294673722640294e+00,0.17151190913639138079e+00,
     0.22338668642896638163e+00,0.21915685840158749640e+00,
     0.22551049979820668739e+00,0.67207754295990703540e-01,
     0.25807598096176653565e-01,0.10031427861179557877e+00,
     0.84345657393211062463e-02,0.46462893261757986541e-01,
     0.85755920049990351154e-01,0.10957842105592463824e+00,
     0.99909812496766759766e+00,0.25447807915618744154e-02,
     0.98153114955374010687e+00,0.16446049854387810934e-01,
     0.92965485742974005667e+00,0.35957103307129322097e-01,
     0.83672593816886873550e+00,0.56979509494123357412e-01,
     0.70249620649152707861e+00,0.76879620499003531043e-01,
     0.53131974364437562397e+00,0.93627109981264473617e-01,
     0.33113539325797683309e+00,0.10566989358023480974e+00,
     0.11248894313318662575e+00,0.11195687302095345688e+00,
     0.11275525672076869161e+00,0.33603877148207730542e-01,
     0.12903800100351265626e-01,0.50157139305899537414e-01,
     0.42176304415588548391e-02,0.23231446639910269443e-01,
     0.42877960025007734493e-01,0.54789210527962865032e-01,
     0.12651565562300680114e-02,0.82230079572359296693e-02,
     0.17978551568128270333e-01,0.28489754745833548613e-01,
     0.38439810249455532039e-01,0.46813554990628012403e-01,
     0.52834946790116519862e-01,0.55978436510476319408e-01,
     0.99987288812035761194e+00,0.36322148184553065969e-03,
     0.99720625937222195908e+00,0.25790497946856882724e-02,
     0.98868475754742947994e+00,0.61155068221172463397e-02,
     0.97218287474858179658e+00,0.10498246909621321898e-01,
     0.94634285837340290515e+00,0.15406750466559497802e-01,
     0.91037115695700429250e+00,0.20594233915912711149e-01,
     0.86390793819369047715e+00,0.25869679327214746911e-01,
     0.80694053195021761186e+00,0.31073551111687964880e-01,
     0.73975604435269475868e+00,0.36064432780782572640e-01,
     0.66290966002478059546e+00,0.40715510116944318934e-01,
     0.57719571005204581484e+00,0.44914531653632197414e-01,
     0.48361802694584102756e+00,0.48564330406673198716e-01,
     0.38335932419873034692e+00,0.51583253952048458777e-01,
     0.27774982202182431507e+00,0.53905499335266063927e-01,
     0.16823525155220746498e+00,0.55481404356559363988e-01,
     0.56344313046592789972e-01,0.56277699831254301273e-01,
     0.56377628360384717388e-01,0.16801938574103865271e-01,
     0.64519000501757369228e-02,0.25078569652949768707e-01,
     0.21088152457266328793e-02,0.11615723319955134727e-01,
     0.21438980012503857246e-01,0.27394605263981432516e-01,
     0.63260731936263354422e-03,0.41115039786546930472e-02,
     0.89892757840641357233e-02,0.14244877372916774306e-01,
     0.19219905124727766019e-01,0.23406777495314006201e-01,
     0.26417473395058259931e-01,0.27989218255238159704e-01,
     0.18073956444538835782e-03,0.12895240826104173921e-02,
     0.30577534101755311361e-02,0.52491234548088591251e-02,
     0.77033752332797418482e-02,0.10297116957956355524e-01,
     0.12934839663607373445e-01,0.15536775555843982440e-01,
     0.18032216390391286320e-01,0.20357755058472159467e-01,
     0.22457265826816098707e-01,0.24282165203336599358e-01,
     0.25791626976024229388e-01,0.26952749667633031963e-01,
     0.27740702178279681994e-01,0.28138849915627150636e-01,
     0.99998243035489159858e+00,0.50536095207862517625e-04,
     0.99959879967191068325e+00,0.37774664632698466027e-03,
     0.99831663531840739285e+00,0.93836984854238150079e-03,
     0.99572410469840718851e+00,0.16811428654214699063e-02,
     0.99149572117810613240e+00,0.25687649437940203731e-02,
     0.98537149959852037111e+00,0.35728927835172996494e-02,
     0.97714151463970571416e+00,0.46710503721143217474e-02,
     0.96663785155841656709e+00,0.58434498758356395076e-02,
     0.95373000642576113641e+00,0.70724899954335554680e-02,
     0.93832039777959288365e+00,0.83428387539681577056e-02,
     0.92034002547001242073e+00,0.96411777297025366953e-02,
     0.89974489977694003664e+00,0.10955733387837901648e-01,
     0.87651341448470526974e+00,0.12275830560082770087e-01,
     0.85064449476835027976e+00,0.13591571009765546790e-01,
     0.82215625436498040737e+00,0.14893641664815182035e-01,
     0.79108493379984836143e+00,0.16173218729577719942e-01,
     0.75748396638051363793e+00,0.17421930159464173747e-01,
     0.72142308537009891548e+00,0.18631848256138790186e-01,
     0.68298743109107922809e+00,0.19795495048097499488e-01,
     0.64227664250975951377e+00,0.20905851445812023852e-01,
     0.59940393024224289297e+00,0.21956366305317824939e-01,
     0.55449513263193254887e+00,0.22940964229387748761e-01,
     0.50768775753371660215e+00,0.23854052106038540080e-01,
     0.45913001198983233287e+00,0.24690524744487676909e-01,
     0.40897982122988867241e+00,0.25445769965464765813e-01,
     0.35740383783153215238e+00,0.26115673376706097680e-01,
     0.30457644155671404334e+00,0.26696622927450359906e-01,
     0.25067873030348317661e+00,0.27185513229624791819e-01,
     0.19589750271110015392e+00,0.27579749566481873035e-01,
     0.14042423315256017459e+00,0.27877251476613701609e-01,
     0.84454040083710883710e-01,0.28076455793817246607e-01,
     0.28184648949745694339e-01,0.28176319033016602131e-01,
	 0.28188814180192358694e-01,0.84009692870519326354e-02,
     0.32259500250878684614e-02,0.12539284826474884353e-01,
     0.10544076228633167722e-02,0.58078616599775673635e-02,
     0.10719490006251933623e-01,0.13697302631990716258e-01,
     0.31630366082226447689e-03,0.20557519893273465236e-02,
     0.44946378920320678616e-02,0.71224386864583871532e-02,
     0.96099525623638830097e-02,0.11703388747657003101e-01,
     0.13208736697529129966e-01,0.13994609127619079852e-01,
     0.90372734658751149261e-04,0.64476204130572477933e-03,
     0.15288767050877655684e-02,0.26245617274044295626e-02,
     0.38516876166398709241e-02,0.51485584789781777618e-02,
     0.64674198318036867274e-02,0.77683877779219912200e-02,
     0.90161081951956431600e-02,0.10178877529236079733e-01,
     0.11228632913408049354e-01,0.12141082601668299679e-01,
     0.12895813488012114694e-01,0.13476374833816515982e-01,
     0.13870351089139840997e-01,0.14069424957813575318e-01,
     0.25157870384280661489e-04,0.18887326450650491366e-03,
     0.46918492424785040975e-03,0.84057143271072246365e-03,
     0.12843824718970101768e-02,0.17864463917586498247e-02,
     0.23355251860571608737e-02,0.29217249379178197538e-02,
     0.35362449977167777340e-02,0.41714193769840788528e-02,
     0.48205888648512683476e-02,0.54778666939189508240e-02,
     0.61379152800413850435e-02,0.67957855048827733948e-02,
     0.74468208324075910174e-02,0.80866093647888599710e-02,
     0.87109650797320868736e-02,0.93159241280693950932e-02,
     0.98977475240487497440e-02,0.10452925722906011926e-01,
     0.10978183152658912470e-01,0.11470482114693874380e-01,
     0.11927026053019270040e-01,0.12345262372243838455e-01,
     0.12722884982732382906e-01,0.13057836688353048840e-01,
     0.13348311463725179953e-01,0.13592756614812395910e-01,
     0.13789874783240936517e-01,0.13938625738306850804e-01,
     0.14038227896908623303e-01,0.14088159516508301065e-01,
     0.99999759637974846462e+00,0.69379364324108267170e-05,
     0.99994399620705437576e+00,0.53275293669780613125e-04,
     0.99976049092443204733e+00,0.13575491094922871973e-03,
     0.99938033802502358193e+00,0.24921240048299729402e-03,
     0.99874561446809511470e+00,0.38974528447328229322e-03,
     0.99780535449595727456e+00,0.55429531493037471492e-03,
     0.99651414591489027385e+00,0.74028280424450333046e-03,
     0.99483150280062100052e+00,0.94536151685852538246e-03,
     0.99272134428278861533e+00,0.11674841174299594077e-02,
     0.99015137040077015918e+00,0.14049079956551446427e-02,
     0.98709252795403406719e+00,0.16561127281544526052e-02,
     0.98351865757863272876e+00,0.19197129710138724125e-02,
     0.97940628167086268381e+00,0.21944069253638388388e-02,
     0.97473445975240266776e+00,0.24789582266575679307e-02,
     0.96948465950245983177e+00,0.27721957645934509940e-02,
     0.96364062156981213252e+00,0.30730184347025783234e-02,
     0.95718821610986096274e+00,0.33803979910869203823e-02,
     0.95011529752129487656e+00,0.36933779170256508183e-02,
     0.94241156519108305981e+00,0.40110687240750233989e-02,
     0.93406843615772578800e+00,0.43326409680929828545e-02,
     0.92507893290707565236e+00,0.46573172997568547773e-02,
     0.91543758715576504064e+00,0.49843645647655386012e-02,
     0.90514035881326159519e+00,0.53130866051870565663e-02,
     0.89418456833555902286e+00,0.56428181013844441585e-02,
     0.88256884024734190684e+00,0.59729195655081658049e-02,
     0.87029305554811390585e+00,0.63027734490857587172e-02,
     0.85735831088623215653e+00,0.66317812429018878941e-02,
     0.84376688267270860104e+00,0.69593614093904229394e-02,
     0.82952219463740140018e+00,0.72849479805538070639e-02,
     0.81462878765513741344e+00,0.76079896657190565832e-02,
     0.79909229096084140180e+00,0.79279493342948491103e-02,
     0.78291939411828301639e+00,0.82443037630328680306e-02,
     0.76611781930376009072e+00,0.85565435613076896192e-02,
     0.74869629361693660282e+00,0.88641732094824942641e-02,
     0.73066452124218126133e+00,0.91667111635607884067e-02,
     0.71203315536225203459e+00,0.94636899938300652943e-02,
     0.69281376977911470289e+00,0.97546565363174114611e-02,
     0.67301883023041847920e+00,0.10039172044056840798e-01,
     0.65266166541001749610e+00,0.10316812330947621682e-01,
     0.63175643771119423041e+00,0.10587167904885197931e-01,
     0.61031811371518640016e+00,0.10849844089337314099e-01,
     0.58836243444766254143e+00,0.11104461134006926537e-01,
     0.56590588542365442262e+00,0.11350654315980596602e-01,
     0.54296566649831149049e+00,0.11588074033043952568e-01,
     0.51955966153745702199e+00,0.11816385890830235763e-01,
     0.49570640791876146017e+00,0.12035270785279562630e-01,
     0.47142506587165887693e+00,0.12244424981611985899e-01,
     0.44673538766202847374e+00,0.12443560190714035263e-01,
     0.42165768662616330006e+00,0.12632403643542078765e-01,
     0.39621280605761593918e+00,0.12810698163877361967e-01,
     0.37042208795007823014e+00,0.12978202239537300286e-01,
     0.34430734159943802278e+00,0.13134690091960152836e-01,
     0.31789081206847668318e+00,0.13279951743930530650e-01,
     0.29119514851824668196e+00,0.13413793085110098513e-01,
     0.26424337241092676194e+00,0.13536035934956213614e-01,
     0.23705884558982972721e+00,0.13646518102571291428e-01,
     0.20966523824318119477e+00,0.13745093443001896632e-01,
     0.18208649675925219825e+00,0.13831631909506428676e-01,
     0.15434681148137810869e+00,0.13906019601325461264e-01,
     0.12647058437230196685e+00,0.13968158806516938516e-01,
     0.98482396598119202090e-01,0.14017968039456608810e-01,
     0.70406976042855179063e-01,0.14055382072649964277e-01,
     0.42269164765363603212e-01,0.14080351962553661325e-01,
     0.14093886410782462614e-01,0.14092845069160408355e-01,
     0.14094407090096179347e-01 };

#include <math.h>
#define kmax1D 7
int adaptive_1D_integration(int ncal, void func(double, double *, void *), double a, double b, double eps, 
		 double *result, double *work, void *param) {
/*	static int kmax=7;*/
	const double *P= EM_AdaptiveIntegrator::P;
	const double *p;
	double *vals, *f, *rold, *rnew;
	double *val;
	double s,c, pts;
	int i1,i2;
	int  i, n, k;
	int converged=0;
/*  work : ncal*(128+3) of double  */
	f = work;
	rold = f+ncal;
	rnew = rold+ncal;
	vals=rnew+ncal;

	s=.5*(b-a);
    c=.5*(a+b);
	i2=1;
	p=P;
	val=vals;
    func(c,val,param );
	for(n=0; n<ncal; ++n){
		rold[n]=val[n]*2.;
		rnew[n]=0.;
	}

	for(k=1; k<=kmax1D && !converged; ++k){
		if(k >1) {
			for(n=0; n<ncal; ++n){
				rold[n]=rnew[n];
				rnew[n]=0.;
			}
			for(i=1;i<i2; ++i){
				val += ncal; 
				for(n=0; n<ncal; ++n) rnew[n] +=*p *val[n];
				++p;
			}
		}
	    i1=i2;
		i2 += i1;
		for(i=i1; i<i2; ++i) {
			pts=*(p++)*s;
			func(c+pts,f, param);
			val +=ncal;
			for(n=0; n<ncal; ++n) val[n]=f[n];
			func(c-pts,f, param);
			for(n=0; n<ncal; ++n){
				val[n] +=f[n];
				rnew[n] +=*p *val[n];
			}
			++p;
		}

		val=vals;
		for(n=0; n<ncal; ++n) rnew[n] += *p *val[n];
		++p;

		converged=1;
		for(n=0; n<ncal; ++n) {
			if(fabs(rnew[n]-rold[n]) > eps*fabs(rnew[n])) {
				converged=0;
				break;
			}
		}
	}
	for(n=0; n<ncal; ++n) result[n]=s* rnew[n];
	return k-1;
}
/*
static struct z_integral_parameter{
	int ncal;
	void (*func)(double*, double *);
	double a, b;
	int points;
	double *work;
} parm;
*/




